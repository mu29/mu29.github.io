
<!DOCTYPE html>
<html lang="ko">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Yeoubi">
    <title>Lambda와 SNS로 백그라운드 작업 처리하기 - Yeoubi</title>
    <meta name="author" content="Injung Chung">
    
    
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Injung Chung","sameAs":["https://github.com/mu29","https://www.linkedin.com/in/mu29/","mailto:mu29@yeoubi.net"],"image":"https://www.gravatar.com/avatar/e323061b0128a2d8934301bb669b1f87"},"articleBody":"스노우 입사 전, 한 달 정도의 여유 기간 동안 영어 학습 뉴스레터 서비스를 만들어 운영을 시작했다. 친구 둘과 나를 포함해 총 세 명이 초기 사용자가 되어 서버 비용을 간신히 충당할 수 있었지만, 한 푼이 아쉬운 상황이라는 데에는 큰 차이가 없었다.\n사이드 프로젝트라고 공부도 할 겸 처음 써보는 기술을 몇 개 쓰다 보니, 프론트엔드 개발에 생각보다 시간을 많이 쓰게 되어 백엔드는 익숙한 스택으로 빠르게 개발한 것이 문제라면 문제였다. 서버는 Ruby on Rails로 개발했고, 메일 발송을 백그라운드에서 처리하기 위해 Resque를 사용했다. Google Cloud Platform의 무료 크레딧을 사용하기 위해 App Engine, Cloud SQL, 그리고 Cloud Memorystore를 사용했다. 덕분에 시작부터 서비스 유지비로만 한 달에 $80 정도가 나가는 상황이 됐다.\nLambda그러기를 몇 달, 무료 크레딧을 다 사용하고 본격적으로 돈이 빠져나가기 시작하자 머리가 아파졌다. 가장 작은 인스턴스를 사용해도 CPU나 메모리 사용량은 수%를 넘지 못하고 있었다. 서비스 특성상 API 호출이 많지 않기 때문이다. 바로 떠오른 게 Serverless였다. Lambda의 무료 사용량을 다 쓸 정도면 나는 백만장자가 될 게 분명했다. (왜 Cloud Functions가 아니라 Lambda냐고 묻는다면.. 나는 Ruby와 ActiveRecord, ActiveSupport를 사랑하는데, Cloud Functions는 Ruby 런타임을 지원하지 않는다.)\nRails 코드를 재작성하려고 보니, 일반적인 요청 - 응답은 간단했지만, 기존에 Resque와 Redis를 사용하여 백그라운드에서 처리하던 메일이나 슬랙 메시지 발송을 어떻게 수정할지가 문제였다. 구현을 위해 Resque의 대략적인 작동 방식을 생각해보면, 아마 작업을 처리하는데 필요한 인자들과 실행할 작업 이름을 직렬화해 Redis 등의 데이터베이스에 저장하고, 서버에서 일정 시간마다 질의해 작업 이름과 인자를 받아 작업을 실행하는 식일 것이다.\n처음에는 Redis 대신 SQS를 사용하려 했지만, 메시지가 최대 14일까지만 보존되는 제한이 있었다. 구독 해지 작업을 예약하는 경우, 1년 이용권을 구입한 지 얼마 되지 않아 바로 해지한다면 약 1년 정도 뒤에 작업이 실행되어야 하기 때문에 SQS는 사용하기 어려웠다.\n비용을 줄이는 게 목적이고 작업이 Redis를 사용해야 할 정도로 많거나 속도에 민감하지 않기 때문에 직렬화한 작업 데이터는 MySQL에 저장하기로 했다. 서버에서 일정 시간마다 질의하는 부분은 마침 Lambda가 Scheduling을 지원해서 5분마다 작업 대기열을 확인해 실행 시간이 지난 작업을 실행 후 삭제하도록 했다. 아래와 같은 구조로 작동한다고 생각하면 된다.\n\n여기까지 작업한 코드는 아래와 같다.\napp/models/pending_job.rb123456class PendingJob &lt; ActiveRecord::Base  # klass     : string  # params    : text  # wait_until: datetime  scope :enqueued, -&gt; &#123; where(wait_until: 0...Time.now) &#125;end\n실행할 작업 이름 (klass), 필요한 인자 (params), 그리고 실행 시간 (wait_until)을 저장하는 모델\nfunctions/execute_pending_jobs.rb12345678910def handler(event:, context:)  PendingJob.enqueued.each do |job|    params = JSON.parse(job.params).symbolize_keys    job.klass.constantize.execute(params)    job.destroy  endrescue =&gt; e  logger = Logger.new(STDERR)  logger.error e.inspectend\n5분마다 작업 대기열을 확인해 실행 시간이 지난 작업을 실행 후 삭제하는 Lambda 함수\napp/common/base_job.rb1234567891011module Jobs  class Base    def self.schedule(with:, wait_until:)      PendingJob.create(        klass: self.to_s,        params: with.to_json,        wait_until: wait_until,      )    end  endend\napp/jobs/send_email_job.rb1234567891011121314151617181920212223class Jobs::SendEmail &lt; Jobs::Base  def execute(to:, subject:, body:)    client = Aws::SES::Client.new(region: 'us-east-1')    client.send_email(&#123;      destination: &#123;        to_addresses: [to],      &#125;,      message: &#123;        subject: &#123;          charset: 'UTF-8',          data: subject,        &#125;,        body: &#123;          html: &#123;            charset: 'UTF-8',            data: body,          &#125;,        &#125;,      &#125;,      source: 'Mailenglish &lt;service@mailenglish.co&gt;',    &#125;)  endend\n그리고 실제로 메일을 발송하는 작업 코드이다. 아래처럼 사용할 수 있다.\n12345678Jobs::SendEmail.schedule(  with: &#123;    to: 'mu29@yeoubi.net',    subject: 'Lorem Ipsum',    body: 'dolor sit amet, consectetur adipiscing elit',  &#125;,  wait_until: 1.days.from_now,)\nSimple Notification Service이렇게 문제가 해결되면 좋았겠지만 이 방법은 확장성이 떨어진다. 메일 한 건 발송에는 약 1~2초 정도가 소요되기 때문에 정해진 시간에 한꺼번에 뉴스레터를 발송하면 Lambda의 900초 실행 시간 제한에 걸리게 된다. (사실 개발할 때는 30초인 줄 알았다. ㅠㅠ) 그래서 작업을 대기열에서 빼내는 함수와 작업을 실행하는 함수를 분리하기로 했다.\n작업을 대기열에서 빼내는 함수는 앞의 execute_pending_jobs와 내용이 비슷하지만, 작업을 바로 실행하는 대신 SNS 주제에 메시지를 게시한다. 작업을 실행하는 함수는 SNS 주제를 구독하고, 메시지가 들어오면 그로부터 작업 이름과 인자를 받아내어 작업을 실행한다. 아래와 같은 구조로 작동한다고 생각하면 된다.\n\nSNS 주제에는 메시지를 빠르게 게시할 수 있고 순간적으로 많은 메시지가 들어와도 그만큼 많은 Lambda 함수를 실행할 것이기 때문에 다량의 작업을 처리하기에도 무리가 없는 구조라고 판단했다. 변경된 코드는 다음과 같다.\napp/common/base_job.rb1234567891011121314151617181920212223module Jobs  class Base    def self.schedule(with:, wait_until:)      PendingJob.create(        klass: self.to_s,        params: with.to_json,        wait_until: wait_until,      )    end    def self.perform(params, id = nil)      @client ||= Aws::SNS::Client.new      @client.publish(        topic_arn: 'SNS 주제',        message: &#123;          id: id,          klass: self.to_s,          params: params.to_json,        &#125;.to_json,      )    end  endend\nfunctions/enqueue_pending_jobs.rb12345678def handler(event:, context:)  PendingJob.enqueued.each do |job|    job.klass.constantize.perform(job.params, job.id)  endrescue =&gt; e  logger = Logger.new(STDERR)  logger.error e.inspectend\nfunctions/execute_pending_jobs.rb1234567891011121314151617181920def handler(event:, context:)  messages = event['Records'].map do |record|    JSON.parse(record['Sns']['Message']).symbolize_keys  end  messages.each do |message|    klass = message[:klass]    params = message[:params]    id = message[:id]&amp;.to_i    while params.is_a? String      params = JSON.parse(params)    end    klass.constantize.new.execute(params.symbolize_keys)    PendingJob.destroy(id) unless id.nil?  endrescue =&gt; e  logger = Logger.new(STDERR)  logger.error e.inspectend\n위의 아키텍처 다이어그램을 보면 알겠지만 SNS로 함수를 실행함으로써 얻는 또 하나의 이점이 있다. 이제 작업을 예약 없이 바로 백그라운드에서 처리할 수 있게 됐다. (API에서 바로 SNS 호출)\nLambda만 사용하는 버전에서 회원가입 후 환영 이메일을 발송하는 과정을 생각해 보자. 회원가입을 완료하면 Jobs::SendEmail.schedule()을 사용하여 작업 정보를 데이터베이스에 저장하고, 일정 시간 뒤(최대 5분)에 enqueue_pending_jobs 함수가 작업을 실행하여 메일을 보내게 된다. 물론 백그라운드에서 처리하지 않고 바로 Jobs::SendEmail.execute()를 할 수도 있지만 둘 다 권장하는 방법은 아니다.\nSNS까지 함께 사용하는 버전에서는 Jobs::SendEmail.perform()을 실행하면 된다! 🎉\n마무리지금은 백엔드를 전부 Lambda + SNS로 변경했고, 무료 사용량 내에서 쓰고 있다. 아직 RDS에 매달 $30씩 지불하고 있지만, 이마저도 dynamodb를 사용하면 돈 한 푼 들이지 않고 서비스를 운영할 수 있다. 물론 앞서 말했듯 나는 ActiveRecord와 ActiveSupport를 사랑하기 때문에 (..) 당분간은 이대로 서비스할 것 같다. 가볍게 시작한 글이 배경 설명과 코드 예제까지 들어가 길어졌다. 실제로 작동하는 예시 프로젝트는 Github에서 확인할 수 있다.\n","dateCreated":"2020-01-22T00:00:00+09:00","dateModified":"2020-09-27T15:03:06+09:00","datePublished":"2020-01-22T00:00:00+09:00","description":"","headline":"Lambda와 SNS로 백그라운드 작업 처리하기","image":["v2.png"],"mainEntityOfPage":{"@type":"WebPage","@id":"https://yeoubi.net/2020/01/22/sns-lambda-background-processing/"},"publisher":{"@type":"Organization","name":"Injung Chung","sameAs":["https://github.com/mu29","https://www.linkedin.com/in/mu29/","mailto:mu29@yeoubi.net"],"image":"https://www.gravatar.com/avatar/e323061b0128a2d8934301bb669b1f87","logo":{"@type":"ImageObject","url":"https://www.gravatar.com/avatar/e323061b0128a2d8934301bb669b1f87"}},"url":"https://yeoubi.net/2020/01/22/sns-lambda-background-processing/","keywords":"background processing, serverless, lambda, sns","thumbnailUrl":"v2.png"}</script>
    <meta name="description" content="스노우 입사 전, 한 달 정도의 여유 기간 동안 영어 학습 뉴스레터 서비스를 만들어 운영을 시작했다. 친구 둘과 나를 포함해 총 세 명이 초기 사용자가 되어 서버 비용을 간신히 충당할 수 있었지만, 한 푼이 아쉬운 상황이라는 데에는 큰 차이가 없었다. 사이드 프로젝트라고 공부도 할 겸 처음 써보는 기술을 몇 개 쓰다 보니, 프론트엔드 개발에 생각보다 시간을">
<meta name="keywords" content="background processing,serverless,lambda,sns">
<meta property="og:type" content="blog">
<meta property="og:title" content="Lambda와 SNS로 백그라운드 작업 처리하기">
<meta property="og:url" content="https://yeoubi.net/2020/01/22/sns-lambda-background-processing/index.html">
<meta property="og:site_name" content="Yeoubi">
<meta property="og:description" content="스노우 입사 전, 한 달 정도의 여유 기간 동안 영어 학습 뉴스레터 서비스를 만들어 운영을 시작했다. 친구 둘과 나를 포함해 총 세 명이 초기 사용자가 되어 서버 비용을 간신히 충당할 수 있었지만, 한 푼이 아쉬운 상황이라는 데에는 큰 차이가 없었다. 사이드 프로젝트라고 공부도 할 겸 처음 써보는 기술을 몇 개 쓰다 보니, 프론트엔드 개발에 생각보다 시간을">
<meta property="og:locale" content="ko">
<meta property="og:image" content="https://yeoubi.net/2020/01/22/sns-lambda-background-processing/v1.png">
<meta property="og:image" content="https://yeoubi.net/2020/01/22/sns-lambda-background-processing/v2.png">
<meta property="og:updated_time" content="2020-09-27T06:03:06.286Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Lambda와 SNS로 백그라운드 작업 처리하기">
<meta name="twitter:description" content="스노우 입사 전, 한 달 정도의 여유 기간 동안 영어 학습 뉴스레터 서비스를 만들어 운영을 시작했다. 친구 둘과 나를 포함해 총 세 명이 초기 사용자가 되어 서버 비용을 간신히 충당할 수 있었지만, 한 푼이 아쉬운 상황이라는 데에는 큰 차이가 없었다. 사이드 프로젝트라고 공부도 할 겸 처음 써보는 기술을 몇 개 쓰다 보니, 프론트엔드 개발에 생각보다 시간을">
<meta name="twitter:image" content="https://yeoubi.net/2020/01/22/sns-lambda-background-processing/v1.png">
    
    
        
    
    
    
        <meta property="og:image" content="https://yeoubi.net/2020/01/22/sns-lambda-background-processing/v2.png"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://yeoubi.net/2020/01/22/sns-lambda-background-processing/v2.png" />
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-ib0ldfeqmntqjx7dbm7egied1yu2vaviyn913t9jw5akrbqm45yr7q7d1zxk.min.css">
    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-137892286-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-137892286-1');
    </script>


    
    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    

<header id="header" data-behavior="3">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">Yeoubi</a>
    </div>
    
        
            <a  class="header-right-picture "
                href="/search">
        
        
        </a>
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/notosanskr.css" />
</header>

            <!-- Define author's picture -->


<nav id="sidebar" data-behavior="3">
    <div class="sidebar-container">
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/ "
                            
                            title="Home"
                        >
                    
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-categories"
                            
                            title="Categories"
                        >
                    
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-tags"
                            
                            title="Tags"
                        >
                    
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-archives"
                            
                            title="Archives"
                        >
                    
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/search"
                            
                            title="Search"
                        >
                    
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Search</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://github.com/mu29" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://www.linkedin.com/in/mu29/" target="_blank" rel="noopener" title="LinkedIn">
                    
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="mailto:mu29@yeoubi.net" target="_blank" rel="noopener" title="Mail">
                    
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="3"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            Lambda와 SNS로 백그라운드 작업 처리하기
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2020-01-22T00:00:00+09:00">
	
		    1월 22, 2020
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/backend/">backend</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>스노우 입사 전, 한 달 정도의 여유 기간 동안 <a href="https://mailenglish.co" target="_blank" rel="noopener">영어 학습 뉴스레터 서비스</a>를 만들어 운영을 시작했다. 친구 둘과 나를 포함해 총 세 명이 초기 사용자가 되어 서버 비용을 간신히 충당할 수 있었지만, 한 푼이 아쉬운 상황이라는 데에는 큰 차이가 없었다.</p>
<p>사이드 프로젝트라고 공부도 할 겸 처음 써보는 기술을 몇 개 쓰다 보니, 프론트엔드 개발에 생각보다 시간을 많이 쓰게 되어 백엔드는 익숙한 스택으로 빠르게 개발한 것이 문제라면 문제였다. 서버는 Ruby on Rails로 개발했고, 메일 발송을 백그라운드에서 처리하기 위해 Resque를 사용했다. Google Cloud Platform의 무료 크레딧을 사용하기 위해 App Engine, Cloud SQL, 그리고 Cloud Memorystore를 사용했다. 덕분에 시작부터 서비스 유지비로만 한 달에 $80 정도가 나가는 상황이 됐다.</p>
<h2 id="Lambda"><a href="#Lambda" class="headerlink" title="Lambda"></a>Lambda</h2><p>그러기를 몇 달, 무료 크레딧을 다 사용하고 본격적으로 돈이 빠져나가기 시작하자 머리가 아파졌다. 가장 작은 인스턴스를 사용해도 CPU나 메모리 사용량은 수%를 넘지 못하고 있었다. 서비스 특성상 API 호출이 많지 않기 때문이다. 바로 떠오른 게 Serverless였다. Lambda의 무료 사용량을 다 쓸 정도면 나는 백만장자가 될 게 분명했다. (왜 Cloud Functions가 아니라 Lambda냐고 묻는다면.. 나는 Ruby와 ActiveRecord, ActiveSupport를 사랑하는데, Cloud Functions는 Ruby 런타임을 지원하지 않는다.)</p>
<p>Rails 코드를 재작성하려고 보니, 일반적인 요청 - 응답은 간단했지만, 기존에 Resque와 Redis를 사용하여 백그라운드에서 처리하던 메일이나 슬랙 메시지 발송을 어떻게 수정할지가 문제였다. 구현을 위해 Resque의 대략적인 작동 방식을 생각해보면, 아마 작업을 처리하는데 필요한 인자들과 실행할 작업 이름을 직렬화해 Redis 등의 데이터베이스에 저장하고, 서버에서 일정 시간마다 질의해 작업 이름과 인자를 받아 작업을 실행하는 식일 것이다.</p>
<p>처음에는 Redis 대신 SQS를 사용하려 했지만, <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-quotas.html#quotas-messages" target="_blank" rel="noopener">메시지가 최대 14일까지만 보존되는 제한</a>이 있었다. 구독 해지 작업을 예약하는 경우, 1년 이용권을 구입한 지 얼마 되지 않아 바로 해지한다면 약 1년 정도 뒤에 작업이 실행되어야 하기 때문에 SQS는 사용하기 어려웠다.</p>
<p>비용을 줄이는 게 목적이고 작업이 Redis를 사용해야 할 정도로 많거나 속도에 민감하지 않기 때문에 직렬화한 작업 데이터는 MySQL에 저장하기로 했다. 서버에서 일정 시간마다 질의하는 부분은 마침 <a href="https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/tutorial-scheduled-events-schedule-expressions.html" target="_blank" rel="noopener">Lambda가 Scheduling을 지원</a>해서 5분마다 작업 대기열을 확인해 실행 시간이 지난 작업을 실행 후 삭제하도록 했다. 아래와 같은 구조로 작동한다고 생각하면 된다.</p>
<p><img src="/2020/01/22/sns-lambda-background-processing/v1.png" alt="Architecture Diagram" style="margin: auto;"></p>
<p>여기까지 작업한 코드는 아래와 같다.</p>
<p><code>app/models/pending_job.rb</code><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PendingJob</span> &lt; ActiveRecord::Base</span></span><br><span class="line">  <span class="comment"># klass     : string</span></span><br><span class="line">  <span class="comment"># params    : text</span></span><br><span class="line">  <span class="comment"># wait_until: datetime</span></span><br><span class="line">  scope <span class="symbol">:enqueued</span>, -&gt; &#123; where(<span class="symbol">wait_until:</span> <span class="number">0</span>...Time.now) &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>실행할 작업 이름 (<code>klass</code>), 필요한 인자 (<code>params</code>), 그리고 실행 시간 (<code>wait_until</code>)을 저장하는 모델</p>
<p><code>functions/execute_pending_jobs.rb</code><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(<span class="symbol">event:</span>, <span class="symbol">context:</span>)</span></span></span><br><span class="line">  PendingJob.enqueued.each <span class="keyword">do</span> <span class="params">|job|</span></span><br><span class="line">    params = JSON.parse(job.params).symbolize_keys</span><br><span class="line">    job.klass.constantize.execute(params)</span><br><span class="line">    job.destroy</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">rescue</span> =&gt; e</span><br><span class="line">  logger = Logger.new(STDERR)</span><br><span class="line">  logger.error e.inspect</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>5분마다 작업 대기열을 확인해 실행 시간이 지난 작업을 실행 후 삭제하는 Lambda 함수</p>
<p><code>app/common/base_job.rb</code><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Jobs</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Base</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">schedule</span><span class="params">(<span class="symbol">with:</span>, <span class="symbol">wait_until:</span>)</span></span></span><br><span class="line">      PendingJob.create(</span><br><span class="line">        <span class="symbol">klass:</span> <span class="keyword">self</span>.to_s,</span><br><span class="line">        <span class="symbol">params:</span> with.to_json,</span><br><span class="line">        <span class="symbol">wait_until:</span> wait_until,</span><br><span class="line">      )</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p><code>app/jobs/send_email_job.rb</code><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Jobs::SendEmail</span> &lt; Jobs::Base</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">execute</span><span class="params">(<span class="symbol">to:</span>, <span class="symbol">subject:</span>, <span class="symbol">body:</span>)</span></span></span><br><span class="line">    client = Aws::SES::Client.new(<span class="symbol">region:</span> <span class="string">'us-east-1'</span>)</span><br><span class="line">    client.send_email(&#123;</span><br><span class="line">      <span class="symbol">destination:</span> &#123;</span><br><span class="line">        <span class="symbol">to_addresses:</span> [to],</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="symbol">message:</span> &#123;</span><br><span class="line">        <span class="symbol">subject:</span> &#123;</span><br><span class="line">          <span class="symbol">charset:</span> <span class="string">'UTF-8'</span>,</span><br><span class="line">          <span class="symbol">data:</span> subject,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="symbol">body:</span> &#123;</span><br><span class="line">          <span class="symbol">html:</span> &#123;</span><br><span class="line">            <span class="symbol">charset:</span> <span class="string">'UTF-8'</span>,</span><br><span class="line">            <span class="symbol">data:</span> body,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">'Mailenglish &lt;service@mailenglish.co&gt;'</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>그리고 실제로 메일을 발송하는 작업 코드이다. 아래처럼 사용할 수 있다.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Jobs::SendEmail.schedule(</span><br><span class="line">  <span class="symbol">with:</span> &#123;</span><br><span class="line">    <span class="symbol">to:</span> <span class="string">'mu29@yeoubi.net'</span>,</span><br><span class="line">    <span class="symbol">subject:</span> <span class="string">'Lorem Ipsum'</span>,</span><br><span class="line">    <span class="symbol">body:</span> <span class="string">'dolor sit amet, consectetur adipiscing elit'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="symbol">wait_until:</span> <span class="number">1</span>.days.from_now,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h2 id="Simple-Notification-Service"><a href="#Simple-Notification-Service" class="headerlink" title="Simple Notification Service"></a>Simple Notification Service</h2><p>이렇게 문제가 해결되면 좋았겠지만 이 방법은 확장성이 떨어진다. 메일 한 건 발송에는 약 1~2초 정도가 소요되기 때문에 정해진 시간에 한꺼번에 뉴스레터를 발송하면 Lambda의 <a href="https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/limits.html" target="_blank" rel="noopener">900초 실행 시간 제한</a>에 걸리게 된다. (사실 개발할 때는 30초인 줄 알았다. ㅠㅠ) 그래서 <strong>작업을 대기열에서 빼내는 함수</strong>와 <strong>작업을 실행하는 함수</strong>를 분리하기로 했다.</p>
<p><strong>작업을 대기열에서 빼내는 함수</strong>는 앞의 <code>execute_pending_jobs</code>와 내용이 비슷하지만, 작업을 바로 실행하는 대신 SNS 주제에 메시지를 게시한다. <strong>작업을 실행하는 함수</strong>는 SNS 주제를 구독하고, 메시지가 들어오면 그로부터 작업 이름과 인자를 받아내어 작업을 실행한다. 아래와 같은 구조로 작동한다고 생각하면 된다.</p>
<p><img src="/2020/01/22/sns-lambda-background-processing/v2.png" alt="Architecture Diagram" style="margin: auto;"></p>
<p>SNS 주제에는 메시지를 빠르게 게시할 수 있고 순간적으로 많은 메시지가 들어와도 그만큼 많은 Lambda 함수를 실행할 것이기 때문에 다량의 작업을 처리하기에도 무리가 없는 구조라고 판단했다. 변경된 코드는 다음과 같다.</p>
<p><code>app/common/base_job.rb</code><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Jobs</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Base</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">schedule</span><span class="params">(<span class="symbol">with:</span>, <span class="symbol">wait_until:</span>)</span></span></span><br><span class="line">      PendingJob.create(</span><br><span class="line">        <span class="symbol">klass:</span> <span class="keyword">self</span>.to_s,</span><br><span class="line">        <span class="symbol">params:</span> with.to_json,</span><br><span class="line">        <span class="symbol">wait_until:</span> wait_until,</span><br><span class="line">      )</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">perform</span><span class="params">(params, id = <span class="literal">nil</span>)</span></span></span><br><span class="line">      @client <span class="params">||</span>= Aws::SNS::Client.new</span><br><span class="line">      @client.publish(</span><br><span class="line">        <span class="symbol">topic_arn:</span> <span class="string">'SNS 주제'</span>,</span><br><span class="line">        <span class="symbol">message:</span> &#123;</span><br><span class="line">          <span class="symbol">id:</span> id,</span><br><span class="line">          <span class="symbol">klass:</span> <span class="keyword">self</span>.to_s,</span><br><span class="line">          <span class="symbol">params:</span> params.to_json,</span><br><span class="line">        &#125;.to_json,</span><br><span class="line">      )</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p><code>functions/enqueue_pending_jobs.rb</code><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(<span class="symbol">event:</span>, <span class="symbol">context:</span>)</span></span></span><br><span class="line">  PendingJob.enqueued.each <span class="keyword">do</span> <span class="params">|job|</span></span><br><span class="line">    job.klass.constantize.perform(job.params, job.id)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">rescue</span> =&gt; e</span><br><span class="line">  logger = Logger.new(STDERR)</span><br><span class="line">  logger.error e.inspect</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p><code>functions/execute_pending_jobs.rb</code><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(<span class="symbol">event:</span>, <span class="symbol">context:</span>)</span></span></span><br><span class="line">  messages = event[<span class="string">'Records'</span>].map <span class="keyword">do</span> <span class="params">|record|</span></span><br><span class="line">    JSON.parse(record[<span class="string">'Sns'</span>][<span class="string">'Message'</span>]).symbolize_keys</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  messages.each <span class="keyword">do</span> <span class="params">|message|</span></span><br><span class="line">    klass = message[<span class="symbol">:klass</span>]</span><br><span class="line">    params = message[<span class="symbol">:params</span>]</span><br><span class="line">    id = message[<span class="symbol">:id</span>]&amp;.to_i</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> params.is_a? String</span><br><span class="line">      params = JSON.parse(params)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    klass.constantize.new.execute(params.symbolize_keys)</span><br><span class="line">    PendingJob.destroy(id) <span class="keyword">unless</span> id.<span class="literal">nil</span>?</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">rescue</span> =&gt; e</span><br><span class="line">  logger = Logger.new(STDERR)</span><br><span class="line">  logger.error e.inspect</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>위의 아키텍처 다이어그램을 보면 알겠지만 SNS로 함수를 실행함으로써 얻는 또 하나의 이점이 있다. 이제 <strong>작업을 예약 없이 바로 백그라운드에서 처리</strong>할 수 있게 됐다. (API에서 바로 SNS 호출)</p>
<p>Lambda만 사용하는 버전에서 회원가입 후 환영 이메일을 발송하는 과정을 생각해 보자. 회원가입을 완료하면 <code>Jobs::SendEmail.schedule()</code>을 사용하여 작업 정보를 데이터베이스에 저장하고, 일정 시간 뒤(최대 5분)에 <code>enqueue_pending_jobs</code> 함수가 작업을 실행하여 메일을 보내게 된다. 물론 백그라운드에서 처리하지 않고 바로 <code>Jobs::SendEmail.execute()</code>를 할 수도 있지만 둘 다 권장하는 방법은 아니다.</p>
<p>SNS까지 함께 사용하는 버전에서는 <code>Jobs::SendEmail.perform()</code>을 실행하면 된다! 🎉</p>
<h2 id="마무리"><a href="#마무리" class="headerlink" title="마무리"></a>마무리</h2><p>지금은 백엔드를 전부 Lambda + SNS로 변경했고, 무료 사용량 내에서 쓰고 있다. 아직 RDS에 매달 $30씩 지불하고 있지만, 이마저도 <a href="https://github.com/Dynamoid/dynamoid" target="_blank" rel="noopener">dynamodb</a>를 사용하면 돈 한 푼 들이지 않고 서비스를 운영할 수 있다. 물론 앞서 말했듯 나는 ActiveRecord와 ActiveSupport를 사랑하기 때문에 (..) 당분간은 이대로 서비스할 것 같다. 가볍게 시작한 글이 배경 설명과 코드 예제까지 들어가 길어졌다. 실제로 작동하는 예시 프로젝트는 <a href="https://github.com/mu29/sns-lambda-background-processing" target="_blank" rel="noopener">Github</a>에서 확인할 수 있다.</p>

            

        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/background-processing/">background processing</a> <a class="tag tag--primary tag--small t-link" href="/tags/lambda/">lambda</a> <a class="tag tag--primary tag--small t-link" href="/tags/serverless/">serverless</a> <a class="tag tag--primary tag--small t-link" href="/tags/sns/">sns</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--disabled">
                
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2019/04/07/50-lines-of-recommendation-engine/" data-tooltip="&#39;실시간 추천엔진 머신한대에 구겨넣기&#39; 50줄로 구현하기" aria-label="NEXT: &#39;실시간 추천엔진 머신한대에 구겨넣기&#39; 50줄로 구현하기">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://yeoubi.net/2020/01/22/sns-lambda-background-processing/" title="페이스북에 공유">
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://yeoubi.net/2020/01/22/sns-lambda-background-processing/" title="트위터에 공유">
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a class="post-action-btn btn btn--default" href="#utterances">
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
                <div id="utterances">
  <script src="https://utteranc.es/client.js"
    repo="mu29/blog-comments"
    issue-term="pathname"
    theme="github-light"
    branch="master"
    crossorigin="anonymous"
    async>
  </script>
</div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2020 Injung Chung. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="3">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--disabled">
                
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2019/04/07/50-lines-of-recommendation-engine/" data-tooltip="&#39;실시간 추천엔진 머신한대에 구겨넣기&#39; 50줄로 구현하기" aria-label="NEXT: &#39;실시간 추천엔진 머신한대에 구겨넣기&#39; 50줄로 구현하기">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://yeoubi.net/2020/01/22/sns-lambda-background-processing/" title="페이스북에 공유">
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://yeoubi.net/2020/01/22/sns-lambda-background-processing/" title="트위터에 공유">
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a class="post-action-btn btn btn--default" href="#utterances">
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="3">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://yeoubi.net/2020/01/22/sns-lambda-background-processing/">
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>페이스북에 공유</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https://yeoubi.net/2020/01/22/sns-lambda-background-processing/">
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>트위터에 공유</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <h4 id="about-card-name">Injung Chung</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Software Engineer @SNOW</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Seoul, Korea
            </div>
        
    </div>
</div>

        
        <div id="cover" style="background-color: #4768AD"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-qdsxe3xwxumzudv25r0gv6xw32omhoauwpjmw5hxpuufed8g00jpgurgzgtc.min.js"></script>
<!--SCRIPTS END-->

    



    </body>
</html>
