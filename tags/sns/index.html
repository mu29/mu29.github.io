
<!DOCTYPE html>
<html lang="ko">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Yeoubi">
    <title>Tag: sns - Yeoubi</title>
    <meta name="author" content="Injung Chung">
    
    
    
    <script type="application/ld+json">{}</script>
    <meta property="og:type" content="blog">
<meta property="og:title" content="Yeoubi">
<meta property="og:url" content="https://yeoubi.net/tags/sns/index.html">
<meta property="og:site_name" content="Yeoubi">
<meta property="og:locale" content="ko">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Yeoubi">
    
    
        
    
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-ib0ldfeqmntqjx7dbm7egied1yu2vaviyn913t9jw5akrbqm45yr7q7d1zxk.min.css">
    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-137892286-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-137892286-1');
    </script>


    
    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    

<header id="header" data-behavior="3">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">Yeoubi</a>
    </div>
    
        
            <a  class="header-right-picture "
                href="/search">
        
        
        </a>
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/notosanskr.css" />
</header>

            <!-- Define author's picture -->


<nav id="sidebar" data-behavior="3">
    <div class="sidebar-container">
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/ "
                            
                            title="Home"
                        >
                    
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-categories"
                            
                            title="Categories"
                        >
                    
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-tags"
                            
                            title="Tags"
                        >
                    
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-archives"
                            
                            title="Archives"
                        >
                    
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/search"
                            
                            title="Search"
                        >
                    
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Search</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://github.com/mu29" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://www.linkedin.com/in/mu29/" target="_blank" rel="noopener" title="LinkedIn">
                    
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="mailto:mu29@yeoubi.net" target="_blank" rel="noopener" title="Mail">
                    
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="3"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2020/01/22/sns-lambda-background-processing/">
                            Lambdaì™€ SNSë¡œ ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… ì²˜ë¦¬í•˜ê¸°
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2020-01-22T00:00:00+09:00">
	
		    1ì›” 22, 2020
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/backend/">backend</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>ìŠ¤ë…¸ìš° ì…ì‚¬ ì „, í•œ ë‹¬ ì •ë„ì˜ ì—¬ìœ  ê¸°ê°„ ë™ì•ˆ <a href="https://mailenglish.co" target="_blank" rel="noopener">ì˜ì–´ í•™ìŠµ ë‰´ìŠ¤ë ˆí„° ì„œë¹„ìŠ¤</a>ë¥¼ ë§Œë“¤ì–´ ìš´ì˜ì„ ì‹œì‘í–ˆë‹¤. ì¹œêµ¬ ë‘˜ê³¼ ë‚˜ë¥¼ í¬í•¨í•´ ì´ ì„¸ ëª…ì´ ì´ˆê¸° ì‚¬ìš©ìê°€ ë˜ì–´ ì„œë²„ ë¹„ìš©ì„ ê°„ì‹ íˆ ì¶©ë‹¹í•  ìˆ˜ ìˆì—ˆì§€ë§Œ, í•œ í‘¼ì´ ì•„ì‰¬ìš´ ìƒí™©ì´ë¼ëŠ” ë°ì—ëŠ” í° ì°¨ì´ê°€ ì—†ì—ˆë‹¤.</p>
<p>ì‚¬ì´ë“œ í”„ë¡œì íŠ¸ë¼ê³  ê³µë¶€ë„ í•  ê²¸ ì²˜ìŒ ì¨ë³´ëŠ” ê¸°ìˆ ì„ ëª‡ ê°œ ì“°ë‹¤ ë³´ë‹ˆ, í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì— ìƒê°ë³´ë‹¤ ì‹œê°„ì„ ë§ì´ ì“°ê²Œ ë˜ì–´ ë°±ì—”ë“œëŠ” ìµìˆ™í•œ ìŠ¤íƒìœ¼ë¡œ ë¹ ë¥´ê²Œ ê°œë°œí•œ ê²ƒì´ ë¬¸ì œë¼ë©´ ë¬¸ì œì˜€ë‹¤. ì„œë²„ëŠ” Ruby on Railsë¡œ ê°œë°œí–ˆê³ , ë©”ì¼ ë°œì†¡ì„ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ Resqueë¥¼ ì‚¬ìš©í–ˆë‹¤. Google Cloud Platformì˜ ë¬´ë£Œ í¬ë ˆë”§ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ App Engine, Cloud SQL, ê·¸ë¦¬ê³  Cloud Memorystoreë¥¼ ì‚¬ìš©í–ˆë‹¤. ë•ë¶„ì— ì‹œì‘ë¶€í„° ì„œë¹„ìŠ¤ ìœ ì§€ë¹„ë¡œë§Œ í•œ ë‹¬ì— $80 ì •ë„ê°€ ë‚˜ê°€ëŠ” ìƒí™©ì´ ëë‹¤.</p>
<h2 id="Lambda"><a href="#Lambda" class="headerlink" title="Lambda"></a>Lambda</h2><p>ê·¸ëŸ¬ê¸°ë¥¼ ëª‡ ë‹¬, ë¬´ë£Œ í¬ë ˆë”§ì„ ë‹¤ ì‚¬ìš©í•˜ê³  ë³¸ê²©ì ìœ¼ë¡œ ëˆì´ ë¹ ì ¸ë‚˜ê°€ê¸° ì‹œì‘í•˜ì ë¨¸ë¦¬ê°€ ì•„íŒŒì¡Œë‹¤. ê°€ì¥ ì‘ì€ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‚¬ìš©í•´ë„ CPUë‚˜ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì€ ìˆ˜%ë¥¼ ë„˜ì§€ ëª»í•˜ê³  ìˆì—ˆë‹¤. ì„œë¹„ìŠ¤ íŠ¹ì„±ìƒ API í˜¸ì¶œì´ ë§ì§€ ì•Šê¸° ë•Œë¬¸ì´ë‹¤. ë°”ë¡œ ë– ì˜¤ë¥¸ ê²Œ Serverlessì˜€ë‹¤. Lambdaì˜ ë¬´ë£Œ ì‚¬ìš©ëŸ‰ì„ ë‹¤ ì“¸ ì •ë„ë©´ ë‚˜ëŠ” ë°±ë§Œì¥ìê°€ ë  ê²Œ ë¶„ëª…í–ˆë‹¤. (ì™œ Cloud Functionsê°€ ì•„ë‹ˆë¼ Lambdaëƒê³  ë¬»ëŠ”ë‹¤ë©´.. ë‚˜ëŠ” Rubyì™€ ActiveRecord, ActiveSupportë¥¼ ì‚¬ë‘í•˜ëŠ”ë°, Cloud FunctionsëŠ” Ruby ëŸ°íƒ€ì„ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤.)</p>
<p>Rails ì½”ë“œë¥¼ ì¬ì‘ì„±í•˜ë ¤ê³  ë³´ë‹ˆ, ì¼ë°˜ì ì¸ ìš”ì²­ - ì‘ë‹µì€ ê°„ë‹¨í–ˆì§€ë§Œ, ê¸°ì¡´ì— Resqueì™€ Redisë¥¼ ì‚¬ìš©í•˜ì—¬ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì²˜ë¦¬í•˜ë˜ ë©”ì¼ì´ë‚˜ ìŠ¬ë™ ë©”ì‹œì§€ ë°œì†¡ì„ ì–´ë–»ê²Œ ìˆ˜ì •í• ì§€ê°€ ë¬¸ì œì˜€ë‹¤. êµ¬í˜„ì„ ìœ„í•´ Resqueì˜ ëŒ€ëµì ì¸ ì‘ë™ ë°©ì‹ì„ ìƒê°í•´ë³´ë©´, ì•„ë§ˆ ì‘ì—…ì„ ì²˜ë¦¬í•˜ëŠ”ë° í•„ìš”í•œ ì¸ìë“¤ê³¼ ì‹¤í–‰í•  ì‘ì—… ì´ë¦„ì„ ì§ë ¬í™”í•´ Redis ë“±ì˜ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ê³ , ì„œë²„ì—ì„œ ì¼ì • ì‹œê°„ë§ˆë‹¤ ì§ˆì˜í•´ ì‘ì—… ì´ë¦„ê³¼ ì¸ìë¥¼ ë°›ì•„ ì‘ì—…ì„ ì‹¤í–‰í•˜ëŠ” ì‹ì¼ ê²ƒì´ë‹¤.</p>
<p>ì²˜ìŒì—ëŠ” Redis ëŒ€ì‹  SQSë¥¼ ì‚¬ìš©í•˜ë ¤ í–ˆì§€ë§Œ, <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-quotas.html#quotas-messages" target="_blank" rel="noopener">ë©”ì‹œì§€ê°€ ìµœëŒ€ 14ì¼ê¹Œì§€ë§Œ ë³´ì¡´ë˜ëŠ” ì œí•œ</a>ì´ ìˆì—ˆë‹¤. êµ¬ë… í•´ì§€ ì‘ì—…ì„ ì˜ˆì•½í•˜ëŠ” ê²½ìš°, 1ë…„ ì´ìš©ê¶Œì„ êµ¬ì…í•œ ì§€ ì–¼ë§ˆ ë˜ì§€ ì•Šì•„ ë°”ë¡œ í•´ì§€í•œë‹¤ë©´ ì•½ 1ë…„ ì •ë„ ë’¤ì— ì‘ì—…ì´ ì‹¤í–‰ë˜ì–´ì•¼ í•˜ê¸° ë•Œë¬¸ì— SQSëŠ” ì‚¬ìš©í•˜ê¸° ì–´ë ¤ì› ë‹¤.</p>
<p>ë¹„ìš©ì„ ì¤„ì´ëŠ” ê²Œ ëª©ì ì´ê³  ì‘ì—…ì´ Redisë¥¼ ì‚¬ìš©í•´ì•¼ í•  ì •ë„ë¡œ ë§ê±°ë‚˜ ì†ë„ì— ë¯¼ê°í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì§ë ¬í™”í•œ ì‘ì—… ë°ì´í„°ëŠ” MySQLì— ì €ì¥í•˜ê¸°ë¡œ í–ˆë‹¤. ì„œë²„ì—ì„œ ì¼ì • ì‹œê°„ë§ˆë‹¤ ì§ˆì˜í•˜ëŠ” ë¶€ë¶„ì€ ë§ˆì¹¨ <a href="https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/tutorial-scheduled-events-schedule-expressions.html" target="_blank" rel="noopener">Lambdaê°€ Schedulingì„ ì§€ì›</a>í•´ì„œ 5ë¶„ë§ˆë‹¤ ì‘ì—… ëŒ€ê¸°ì—´ì„ í™•ì¸í•´ ì‹¤í–‰ ì‹œê°„ì´ ì§€ë‚œ ì‘ì—…ì„ ì‹¤í–‰ í›„ ì‚­ì œí•˜ë„ë¡ í–ˆë‹¤. ì•„ë˜ì™€ ê°™ì€ êµ¬ì¡°ë¡œ ì‘ë™í•œë‹¤ê³  ìƒê°í•˜ë©´ ëœë‹¤.</p>
<p><img src="/2020/01/22/sns-lambda-background-processing/v1.png" alt="Architecture Diagram" style="margin: auto;"></p>
<p>ì—¬ê¸°ê¹Œì§€ ì‘ì—…í•œ ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ë‹¤.</p>
<p><code>app/models/pending_job.rb</code><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PendingJob</span> &lt; ActiveRecord::Base</span></span><br><span class="line">  <span class="comment"># klass     : string</span></span><br><span class="line">  <span class="comment"># params    : text</span></span><br><span class="line">  <span class="comment"># wait_until: datetime</span></span><br><span class="line">  scope <span class="symbol">:enqueued</span>, -&gt; &#123; where(<span class="symbol">wait_until:</span> <span class="number">0</span>...Time.now) &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>ì‹¤í–‰í•  ì‘ì—… ì´ë¦„ (<code>klass</code>), í•„ìš”í•œ ì¸ì (<code>params</code>), ê·¸ë¦¬ê³  ì‹¤í–‰ ì‹œê°„ (<code>wait_until</code>)ì„ ì €ì¥í•˜ëŠ” ëª¨ë¸</p>
<p><code>functions/execute_pending_jobs.rb</code><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(<span class="symbol">event:</span>, <span class="symbol">context:</span>)</span></span></span><br><span class="line">  PendingJob.enqueued.each <span class="keyword">do</span> <span class="params">|job|</span></span><br><span class="line">    params = JSON.parse(job.params).symbolize_keys</span><br><span class="line">    job.klass.constantize.execute(params)</span><br><span class="line">    job.destroy</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">rescue</span> =&gt; e</span><br><span class="line">  logger = Logger.new(STDERR)</span><br><span class="line">  logger.error e.inspect</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>5ë¶„ë§ˆë‹¤ ì‘ì—… ëŒ€ê¸°ì—´ì„ í™•ì¸í•´ ì‹¤í–‰ ì‹œê°„ì´ ì§€ë‚œ ì‘ì—…ì„ ì‹¤í–‰ í›„ ì‚­ì œí•˜ëŠ” Lambda í•¨ìˆ˜</p>
<p><code>app/common/base_job.rb</code><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Jobs</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Base</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">schedule</span><span class="params">(<span class="symbol">with:</span>, <span class="symbol">wait_until:</span>)</span></span></span><br><span class="line">      PendingJob.create(</span><br><span class="line">        <span class="symbol">klass:</span> <span class="keyword">self</span>.to_s,</span><br><span class="line">        <span class="symbol">params:</span> with.to_json,</span><br><span class="line">        <span class="symbol">wait_until:</span> wait_until,</span><br><span class="line">      )</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p><code>app/jobs/send_email_job.rb</code><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Jobs::SendEmail</span> &lt; Jobs::Base</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">execute</span><span class="params">(<span class="symbol">to:</span>, <span class="symbol">subject:</span>, <span class="symbol">body:</span>)</span></span></span><br><span class="line">    client = Aws::SES::Client.new(<span class="symbol">region:</span> <span class="string">'us-east-1'</span>)</span><br><span class="line">    client.send_email(&#123;</span><br><span class="line">      <span class="symbol">destination:</span> &#123;</span><br><span class="line">        <span class="symbol">to_addresses:</span> [to],</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="symbol">message:</span> &#123;</span><br><span class="line">        <span class="symbol">subject:</span> &#123;</span><br><span class="line">          <span class="symbol">charset:</span> <span class="string">'UTF-8'</span>,</span><br><span class="line">          <span class="symbol">data:</span> subject,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="symbol">body:</span> &#123;</span><br><span class="line">          <span class="symbol">html:</span> &#123;</span><br><span class="line">            <span class="symbol">charset:</span> <span class="string">'UTF-8'</span>,</span><br><span class="line">            <span class="symbol">data:</span> body,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="symbol">source:</span> <span class="string">'Mailenglish &lt;service@mailenglish.co&gt;'</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>ê·¸ë¦¬ê³  ì‹¤ì œë¡œ ë©”ì¼ì„ ë°œì†¡í•˜ëŠ” ì‘ì—… ì½”ë“œì´ë‹¤. ì•„ë˜ì²˜ëŸ¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Jobs::SendEmail.schedule(</span><br><span class="line">  <span class="symbol">with:</span> &#123;</span><br><span class="line">    <span class="symbol">to:</span> <span class="string">'mu29@yeoubi.net'</span>,</span><br><span class="line">    <span class="symbol">subject:</span> <span class="string">'Lorem Ipsum'</span>,</span><br><span class="line">    <span class="symbol">body:</span> <span class="string">'dolor sit amet, consectetur adipiscing elit'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="symbol">wait_until:</span> <span class="number">1</span>.days.from_now,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h2 id="Simple-Notification-Service"><a href="#Simple-Notification-Service" class="headerlink" title="Simple Notification Service"></a>Simple Notification Service</h2><p>ì´ë ‡ê²Œ ë¬¸ì œê°€ í•´ê²°ë˜ë©´ ì¢‹ì•˜ê² ì§€ë§Œ ì´ ë°©ë²•ì€ í™•ì¥ì„±ì´ ë–¨ì–´ì§„ë‹¤. ë©”ì¼ í•œ ê±´ ë°œì†¡ì—ëŠ” ì•½ 1~2ì´ˆ ì •ë„ê°€ ì†Œìš”ë˜ê¸° ë•Œë¬¸ì— ì •í•´ì§„ ì‹œê°„ì— í•œêº¼ë²ˆì— ë‰´ìŠ¤ë ˆí„°ë¥¼ ë°œì†¡í•˜ë©´ Lambdaì˜ <a href="https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/limits.html" target="_blank" rel="noopener">900ì´ˆ ì‹¤í–‰ ì‹œê°„ ì œí•œ</a>ì— ê±¸ë¦¬ê²Œ ëœë‹¤. (ì‚¬ì‹¤ ê°œë°œí•  ë•ŒëŠ” 30ì´ˆì¸ ì¤„ ì•Œì•˜ë‹¤. ã… ã… ) ê·¸ë˜ì„œ <strong>ì‘ì—…ì„ ëŒ€ê¸°ì—´ì—ì„œ ë¹¼ë‚´ëŠ” í•¨ìˆ˜</strong>ì™€ <strong>ì‘ì—…ì„ ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜</strong>ë¥¼ ë¶„ë¦¬í•˜ê¸°ë¡œ í–ˆë‹¤.</p>
<p><strong>ì‘ì—…ì„ ëŒ€ê¸°ì—´ì—ì„œ ë¹¼ë‚´ëŠ” í•¨ìˆ˜</strong>ëŠ” ì•ì˜ <code>execute_pending_jobs</code>ì™€ ë‚´ìš©ì´ ë¹„ìŠ·í•˜ì§€ë§Œ, ì‘ì—…ì„ ë°”ë¡œ ì‹¤í–‰í•˜ëŠ” ëŒ€ì‹  SNS ì£¼ì œì— ë©”ì‹œì§€ë¥¼ ê²Œì‹œí•œë‹¤. <strong>ì‘ì—…ì„ ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜</strong>ëŠ” SNS ì£¼ì œë¥¼ êµ¬ë…í•˜ê³ , ë©”ì‹œì§€ê°€ ë“¤ì–´ì˜¤ë©´ ê·¸ë¡œë¶€í„° ì‘ì—… ì´ë¦„ê³¼ ì¸ìë¥¼ ë°›ì•„ë‚´ì–´ ì‘ì—…ì„ ì‹¤í–‰í•œë‹¤. ì•„ë˜ì™€ ê°™ì€ êµ¬ì¡°ë¡œ ì‘ë™í•œë‹¤ê³  ìƒê°í•˜ë©´ ëœë‹¤.</p>
<p><img src="/2020/01/22/sns-lambda-background-processing/v2.png" alt="Architecture Diagram" style="margin: auto;"></p>
<p>SNS ì£¼ì œì—ëŠ” ë©”ì‹œì§€ë¥¼ ë¹ ë¥´ê²Œ ê²Œì‹œí•  ìˆ˜ ìˆê³  ìˆœê°„ì ìœ¼ë¡œ ë§ì€ ë©”ì‹œì§€ê°€ ë“¤ì–´ì™€ë„ ê·¸ë§Œí¼ ë§ì€ Lambda í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•  ê²ƒì´ê¸° ë•Œë¬¸ì— ë‹¤ëŸ‰ì˜ ì‘ì—…ì„ ì²˜ë¦¬í•˜ê¸°ì—ë„ ë¬´ë¦¬ê°€ ì—†ëŠ” êµ¬ì¡°ë¼ê³  íŒë‹¨í–ˆë‹¤. ë³€ê²½ëœ ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.</p>
<p><code>app/common/base_job.rb</code><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Jobs</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Base</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">schedule</span><span class="params">(<span class="symbol">with:</span>, <span class="symbol">wait_until:</span>)</span></span></span><br><span class="line">      PendingJob.create(</span><br><span class="line">        <span class="symbol">klass:</span> <span class="keyword">self</span>.to_s,</span><br><span class="line">        <span class="symbol">params:</span> with.to_json,</span><br><span class="line">        <span class="symbol">wait_until:</span> wait_until,</span><br><span class="line">      )</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">perform</span><span class="params">(params, id = <span class="literal">nil</span>)</span></span></span><br><span class="line">      @client <span class="params">||</span>= Aws::SNS::Client.new</span><br><span class="line">      @client.publish(</span><br><span class="line">        <span class="symbol">topic_arn:</span> <span class="string">'SNS ì£¼ì œ'</span>,</span><br><span class="line">        <span class="symbol">message:</span> &#123;</span><br><span class="line">          <span class="symbol">id:</span> id,</span><br><span class="line">          <span class="symbol">klass:</span> <span class="keyword">self</span>.to_s,</span><br><span class="line">          <span class="symbol">params:</span> params.to_json,</span><br><span class="line">        &#125;.to_json,</span><br><span class="line">      )</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p><code>functions/enqueue_pending_jobs.rb</code><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(<span class="symbol">event:</span>, <span class="symbol">context:</span>)</span></span></span><br><span class="line">  PendingJob.enqueued.each <span class="keyword">do</span> <span class="params">|job|</span></span><br><span class="line">    job.klass.constantize.perform(job.params, job.id)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">rescue</span> =&gt; e</span><br><span class="line">  logger = Logger.new(STDERR)</span><br><span class="line">  logger.error e.inspect</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p><code>functions/execute_pending_jobs.rb</code><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(<span class="symbol">event:</span>, <span class="symbol">context:</span>)</span></span></span><br><span class="line">  messages = event[<span class="string">'Records'</span>].map <span class="keyword">do</span> <span class="params">|record|</span></span><br><span class="line">    JSON.parse(record[<span class="string">'Sns'</span>][<span class="string">'Message'</span>]).symbolize_keys</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  messages.each <span class="keyword">do</span> <span class="params">|message|</span></span><br><span class="line">    klass = message[<span class="symbol">:klass</span>]</span><br><span class="line">    params = message[<span class="symbol">:params</span>]</span><br><span class="line">    id = message[<span class="symbol">:id</span>]&amp;.to_i</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> params.is_a? String</span><br><span class="line">      params = JSON.parse(params)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    klass.constantize.new.execute(params.symbolize_keys)</span><br><span class="line">    PendingJob.destroy(id) <span class="keyword">unless</span> id.<span class="literal">nil</span>?</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">rescue</span> =&gt; e</span><br><span class="line">  logger = Logger.new(STDERR)</span><br><span class="line">  logger.error e.inspect</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>ìœ„ì˜ ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨ì„ ë³´ë©´ ì•Œê² ì§€ë§Œ SNSë¡œ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•¨ìœ¼ë¡œì¨ ì–»ëŠ” ë˜ í•˜ë‚˜ì˜ ì´ì ì´ ìˆë‹¤. ì´ì œ <strong>ì‘ì—…ì„ ì˜ˆì•½ ì—†ì´ ë°”ë¡œ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì²˜ë¦¬</strong>í•  ìˆ˜ ìˆê²Œ ëë‹¤. (APIì—ì„œ ë°”ë¡œ SNS í˜¸ì¶œ)</p>
<p>Lambdaë§Œ ì‚¬ìš©í•˜ëŠ” ë²„ì „ì—ì„œ íšŒì›ê°€ì… í›„ í™˜ì˜ ì´ë©”ì¼ì„ ë°œì†¡í•˜ëŠ” ê³¼ì •ì„ ìƒê°í•´ ë³´ì. íšŒì›ê°€ì…ì„ ì™„ë£Œí•˜ë©´ <code>Jobs::SendEmail.schedule()</code>ì„ ì‚¬ìš©í•˜ì—¬ ì‘ì—… ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ê³ , ì¼ì • ì‹œê°„ ë’¤(ìµœëŒ€ 5ë¶„)ì— <code>enqueue_pending_jobs</code> í•¨ìˆ˜ê°€ ì‘ì—…ì„ ì‹¤í–‰í•˜ì—¬ ë©”ì¼ì„ ë³´ë‚´ê²Œ ëœë‹¤. ë¬¼ë¡  ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì²˜ë¦¬í•˜ì§€ ì•Šê³  ë°”ë¡œ <code>Jobs::SendEmail.execute()</code>ë¥¼ í•  ìˆ˜ë„ ìˆì§€ë§Œ ë‘˜ ë‹¤ ê¶Œì¥í•˜ëŠ” ë°©ë²•ì€ ì•„ë‹ˆë‹¤.</p>
<p>SNSê¹Œì§€ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” ë²„ì „ì—ì„œëŠ” <code>Jobs::SendEmail.perform()</code>ì„ ì‹¤í–‰í•˜ë©´ ëœë‹¤! ğŸ‰</p>
<h2 id="ë§ˆë¬´ë¦¬"><a href="#ë§ˆë¬´ë¦¬" class="headerlink" title="ë§ˆë¬´ë¦¬"></a>ë§ˆë¬´ë¦¬</h2><p>ì§€ê¸ˆì€ ë°±ì—”ë“œë¥¼ ì „ë¶€ Lambda + SNSë¡œ ë³€ê²½í–ˆê³ , ë¬´ë£Œ ì‚¬ìš©ëŸ‰ ë‚´ì—ì„œ ì“°ê³  ìˆë‹¤. ì•„ì§ RDSì— ë§¤ë‹¬ $30ì”© ì§€ë¶ˆí•˜ê³  ìˆì§€ë§Œ, ì´ë§ˆì €ë„ <a href="https://github.com/Dynamoid/dynamoid" target="_blank" rel="noopener">dynamodb</a>ë¥¼ ì‚¬ìš©í•˜ë©´ ëˆ í•œ í‘¼ ë“¤ì´ì§€ ì•Šê³  ì„œë¹„ìŠ¤ë¥¼ ìš´ì˜í•  ìˆ˜ ìˆë‹¤. ë¬¼ë¡  ì•ì„œ ë§í–ˆë“¯ ë‚˜ëŠ” ActiveRecordì™€ ActiveSupportë¥¼ ì‚¬ë‘í•˜ê¸° ë•Œë¬¸ì— (..) ë‹¹ë¶„ê°„ì€ ì´ëŒ€ë¡œ ì„œë¹„ìŠ¤í•  ê²ƒ ê°™ë‹¤. ê°€ë³ê²Œ ì‹œì‘í•œ ê¸€ì´ ë°°ê²½ ì„¤ëª…ê³¼ ì½”ë“œ ì˜ˆì œê¹Œì§€ ë“¤ì–´ê°€ ê¸¸ì–´ì¡Œë‹¤. ì‹¤ì œë¡œ ì‘ë™í•˜ëŠ” ì˜ˆì‹œ í”„ë¡œì íŠ¸ëŠ” <a href="https://github.com/mu29/sns-lambda-background-processing" target="_blank" rel="noopener">Github</a>ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>

                    
                        

                    
                    
                        <p>
                            <a href="/2020/01/22/sns-lambda-background-processing/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
            <a href="/2020/01/22/sns-lambda-background-processing/">
                <div class="postShorten-thumbnailimg">
                    <img alt="" src="https://yeoubi.net/2020/01/22/sns-lambda-background-processing/v2.png"/>
                </div>
            </a>
            
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
        <li class="pagination-number">page 1 of 1</li>
    </ul>
</div>

</section>


                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2020 Injung Chung. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <h4 id="about-card-name">Injung Chung</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Software Engineer @SNOW</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Seoul, Korea
            </div>
        
    </div>
</div>

        
        <div id="cover" style="background-color: #4768AD"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-qdsxe3xwxumzudv25r0gv6xw32omhoauwpjmw5hxpuufed8g00jpgurgzgtc.min.js"></script>
<!--SCRIPTS END-->



    </body>
</html>
