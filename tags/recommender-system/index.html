
<!DOCTYPE html>
<html lang="ko">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Yeoubi">
    <title>Tag: recommender system - Yeoubi</title>
    <meta name="author" content="Injung Chung">
    
    
    
    <script type="application/ld+json">{}</script>
    <meta property="og:type" content="blog">
<meta property="og:title" content="Yeoubi">
<meta property="og:url" content="https://yeoubi.net/tags/recommender-system/index.html">
<meta property="og:site_name" content="Yeoubi">
<meta property="og:locale" content="ko">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Yeoubi">
    
    
        
    
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-ib0ldfeqmntqjx7dbm7egied1yu2vaviyn913t9jw5akrbqm45yr7q7d1zxk.min.css">
    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-137892286-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-137892286-1');
    </script>


    
    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    

<header id="header" data-behavior="3">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">Yeoubi</a>
    </div>
    
        
            <a  class="header-right-picture "
                href="/search">
        
        
        </a>
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/notosanskr.css" />
</header>

            <!-- Define author's picture -->


<nav id="sidebar" data-behavior="3">
    <div class="sidebar-container">
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/ "
                            
                            title="Home"
                        >
                    
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-categories"
                            
                            title="Categories"
                        >
                    
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-tags"
                            
                            title="Tags"
                        >
                    
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-archives"
                            
                            title="Archives"
                        >
                    
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/search"
                            
                            title="Search"
                        >
                    
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Search</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://github.com/mu29" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://www.linkedin.com/in/mu29/" target="_blank" rel="noopener" title="LinkedIn">
                    
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="mailto:mu29@yeoubi.net" target="_blank" rel="noopener" title="Mail">
                    
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="3"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2019/04/07/50-lines-of-recommendation-engine/">
                            &#39;실시간 추천엔진 머신한대에 구겨넣기&#39; 50줄로 구현하기
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-04-07T00:00:00+09:00">
	
		    4월 07, 2019
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/backend/">backend</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>추천 시스템에 관심이 생겨 찾아봤다면 한 번쯤은 <a href="https://www.slideshare.net/deview/261-52784785" target="_blank" rel="noopener">실시간 추천엔진 머신한대에 구겨넣기</a>라는 슬라이드를 마주쳤을 거라고 생각한다. 워낙 유명한 발표라 당시 페이스북에서도 많이 공유 되었던 것 같다. 나 역시 씀 : 일상적 글쓰기를 개발하면서 사용자들에게 구독, 혹은 담아 갈 만한 글을 추천해주고 싶었고, 어떤 식으로 구현할 수 있을지 알아보다 이 슬라이드를 발견했다. 처음 1/3 정도까지는 고개를 끄덕이며 술술 읽어 나갔는데, MinHash, LSH 같은 단어가 보이면서 점점 잠이 오더니, 어떻게 다 읽기는 했다만 ‘그래서 어떻게 한다고?’라는 생각을 하며 브라우저를 닫아 버렸다.</p>
<p>그렇게 몇 달간 추천 시스템은 잊고 지내다가, 최근 Cake 앱 개편 작업을 준비하며 홈 화면 개인화(=추천)라는 주제가 회의에서 이야기되었고, 불현듯 한 번 읽고 넘겨버린 이 자료가 생각나 간단하게 구현해 보기로 했다. 본격적으로 개발을 시작하기 전에, 발표에서 나온 개념들을 하나씩 짚고 넘어가 보자.</p>
<h2 id="Jaccard-Similarity"><a href="#Jaccard-Similarity" class="headerlink" title="Jaccard Similarity"></a>Jaccard Similarity</h2><p>발표 자료에 쉽게 설명이 되어 있다. A가 좋아한 상품이 [1, 2, 3],  B가 좋아한 상품이 [1, 2, 4], C가 좋아한 상품이 [1, 4, 5] 일 때 각 사용자들이 좋아한 상품을 기반으로 서로 얼마나 비슷한지 알아보는 것이다. 두 사용자 A, B의 Jaccard similarity는 다음과 같이 측정할 수 있다.</p>
<p>$$J(A,B) = \frac{|A \cap B|}{|A \cup B|}$$</p>
<p>예를 들어, 앞서 말한 A와 B의 Jaccard similarity는 아래와 같이 구할 수 있다.</p>
<p>$$\frac{|A \cap B|}{|A \cup B|} = \frac{|{1, 2}|}{|{1, 2, 3, 4}|} = 0.5$$</p>
<p>Ruby로 간단하게 구할 수도 있다.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]; b = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>]</span><br><span class="line">(a &amp; b).length / (a <span class="params">| b).length</span></span><br></pre></td></tr></table></figure>
<h2 id="MinHash"><a href="#MinHash" class="headerlink" title="MinHash"></a>MinHash</h2><p>LSH는 발표 자료에 잘 설명이 되어 있는데, MinHash에 관해서는 Jaccard similarity를 유지하는 타입의 LSH라는 것 말고는 별다른 내용이 없다. ‘그래서 MinHash가 구체적으로 뭐지?’ 하는 의문이 들 수 있는데 찾아보면 의외로 간단한 개념이다. n 개의 원소로 이루어진 집합 S에 대하여, 보통 MinHash를 구하기 위해 사용하는 해시 함수는 아래와 같다.</p>
<p>$$h(x) = (a x + b)\bmod p$$</p>
<p>여기서 a와 b는 n보다 작은 임의의 자연수이며, p는 n과 같거나 큰 가장 작은 소수이다.</p>
<p>이전에 설명한 예시를 다시 가져와 보면, 전체 상품이 1 ~ 10까지 있다고 가정하면 n이 10이고, a = 2, b = 8, p = 11로 했을 때, 우리의 첫 번째 해시 함수는 아래와 같을 것이다.</p>
<p>$$h(x) = (2x + 8) \bmod 11$$</p>
<p>이 해시 함수에 사용자의 아이템을 전부 집어넣어 나온 값 중 가장 작은 값이 바로 MinHash 값이다(정확히는 <em>해당 사용자에 대한 이 해시 함수의 MinHash 값</em>). 예시에서 사용자 A의 경우 이 해시 함수를 사용했을 때 MinHash 값이 1, 사용자 B의 경우에도 1, 사용자 C의 경우에는 5가 된다. 그러면 우리는 사용자 A와 B가 같고, C는 다르다고 생각할 수 있다.</p>
<h2 id="Signiture"><a href="#Signiture" class="headerlink" title="Signiture"></a>Signiture</h2><p>MinHash 값을 구하는 과정을 보면 알겠지만, 두 사용자가 서로 다른 아이템을 가지고 있을 때도 MinHash 값은 같을 수 있다. 그래서 실제로 사용할 때는 a, b를 다르게 설정한 해시 함수를 많이 만들어서, MinHash를 여러 개 구하고, 이를 이어 붙여서 사용자의 Signiture를 만든다. 발표 자료에서는 100개를 추천하고 있다. 이렇게 만들어진 Signiture는 사용자 간의 유사도를 구하는데 사용된다. 예를 들어, 사용자 A의 Signiture가 <code>[1, 0, 1, 6, 0]</code>이고, 사용자 B의 Signiture가 <code>[1, 0, 0, 6, 0]</code>이면 둘은 80% 일치한다고 보는 것이다.</p>
<h2 id="Secondary-Index"><a href="#Secondary-Index" class="headerlink" title="Secondary Index"></a>Secondary Index</h2><p>이렇게 구한 Signiture로 사용자 간의 유사도를 구한다는 것은 알겠는데, 추천할 때마다 모든 사용자와 비교해서 비슷한 사용자를 찾는다면 속도에 이점이 전혀 없다. 그래서 발표에서 제시한 것이 Secondary Index이다. 사용자의 각 Signiture와 그 Signiture의 인덱스를 합친 키에, 값을 해당 사용자로 하는 Key-Value 저장소를 만드는 것이다.</p>
<p>글로만 보면 이해하기 어려우니 예시를 통해 더 알아보자. 앞서 예로 든 사용자 A의 Signiture <code>[1, 0, 1, 6, 0]</code>를 각각의 Index와 함께 묶어 키로 만들고, 값에는 사용자 A를 넣어서 Secondary Index를 만든다.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">'1-0'</span> =&gt; [<span class="string">'A'</span>],</span><br><span class="line">  <span class="string">'0-1'</span> =&gt; [<span class="string">'A'</span>],</span><br><span class="line">  <span class="string">'1-2'</span> =&gt; [<span class="string">'A'</span>],</span><br><span class="line">  <span class="string">'6-3'</span> =&gt; [<span class="string">'A'</span>],</span><br><span class="line">  <span class="string">'0-4'</span> =&gt; [<span class="string">'A'</span>],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>잘 보면, 키가 Signiture-Index로 구성되어 있다. 여기에 사용자 B의 Signiture <code>[1, 0, 0, 6, 0]</code>도 넣어 보자.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">'1-0'</span> =&gt; [<span class="string">'A'</span>, <span class="string">'B'</span>],</span><br><span class="line">  <span class="string">'0-1'</span> =&gt; [<span class="string">'A'</span>, <span class="string">'B'</span>],</span><br><span class="line">  <span class="string">'1-2'</span> =&gt; [<span class="string">'A'</span>],</span><br><span class="line">  <span class="string">'6-3'</span> =&gt; [<span class="string">'A'</span>, <span class="string">'B'</span>],</span><br><span class="line">  <span class="string">'0-4'</span> =&gt; [<span class="string">'A'</span>, <span class="string">'B'</span>],</span><br><span class="line">  <span class="string">'0-2'</span> =&gt; [<span class="string">'B'</span>],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>사용자 B의 3번째 Signiture인 0이 <code>0-2</code>로 마지막에 들어갔다. 이제 임의의 사용자와 비슷한 사용자를 찾으려면 해당 사용자의 Signiture를 <code>map</code> 함수를 사용하여 Signiture-Index 형태로 변형하고, Secondary Index에서 가져오면 되겠다.</p>
<p>사용자 A의 Signiture <code>[1, 0, 1, 6, 0]</code>를 Signiture-Index 형태로 변형하면 <code>[&#39;1-0&#39;, &#39;0-1&#39;, &#39;1-2&#39;, &#39;6-3&#39;, &#39;0-4&#39;]</code>가 되고, 이 키들을 가지고 Secondary Index 저장소에서 값을 가져오면   <code>[&#39;A&#39;, &#39;B&#39;], [&#39;A&#39;, &#39;B&#39;], [&#39;A&#39;], [&#39;A&#39;, &#39;B&#39;], [&#39;A&#39;, &#39;B&#39;]</code>가 나올 텐데, 여기서 A를 제외하면 비슷한 사용자 B를 빠르게 찾을 수 있는 것이다. 또, 둘의 유사도는 B의 등장 횟수 4를 Signiture의 길이 5로 나눈 80%가 된다.</p>
<h2 id="비슷한-사용자-비슷한-아이템"><a href="#비슷한-사용자-비슷한-아이템" class="headerlink" title="비슷한 사용자, 비슷한 아이템"></a>비슷한 사용자, 비슷한 아이템</h2><p>발표 자료와 이 글을 함께 보고 있으면 이상한 점을 하나 발견할 수 있다. 이쯤이면 발표 자료는 아이템의 Signiture에 관한 설명을 하고 있기 때문이다. (54페이지) 분명히 처음에는 사용자 기반 협업 필터링이었던 것 같은데?</p>
<p>생각해 보면 이 방법은 비슷한 사용자를 추천하는데도 사용할 수 있고, 비슷한 아이템을 추천하는데도 사용할 수 있다. 다만 한 사용자가 100개 이상의 아이템을 선호하는 경우가 많을지, 한 아이템을 100명 이상의 사용자가 선호하는 경우가 많을지 생각해보면 아이템 추천 시스템을 만드는 것이 좀 더 일리 있어 보이기는 하다.</p>
<p>1) 비슷한 사용자를 추천하는 경우에는 임의의 사용자에게 좋아할 만한 아이템을 추천해 줄 수 있고, 2) 비슷한 아이템을 추천하는 경우에는 사용자가 임의의 아이템을 선호한다는 표현을 했을 때, 그와 비슷한 다른 아이템들을 소개해 줄 수 있을 것이다.</p>
<p>원래 만들고자 한 기능이 홈 화면에서 볼 만한 영상을 추천해주는 것이기 때문에 이 글에서는 첫 번째 방법으로 임의의 사용자에게 좋아할 만한 다른 아이템을 추천해 주는 기능을 구현할 예정이지만, 원한다면 반대로 구현해도 좋다.</p>
<h2 id="50줄로-구현하기"><a href="#50줄로-구현하기" class="headerlink" title="50줄로 구현하기"></a>50줄로 구현하기</h2><p>Redis를 사용하는 부분을 제외하고, 발표에서 이야기하는 실시간 추천 엔진이 어떻게 돌아가는 것인지 Ruby로 간단하게 구현해 보자. 마지막의 전체 코드를 제외한 이 글의 모든 코드는 irb를 사용해서 테스트할 수 있도록 작성했다. 맥 사용자라면 터미널에서 irb를 실행하고 복사-붙여넣기만 해도 작동한다. 테스트 데이터는 발표 자료에 나온 것을 그대로 사용하면 되겠다. (14페이지)</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@likes_data = [</span><br><span class="line">  [<span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">  [<span class="number">1</span>, <span class="number">4</span>, <span class="number">5</span>], <span class="comment"># 2번째 사용자 (나)</span></span><br><span class="line">  [<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">5</span>],</span><br><span class="line">  [<span class="number">2</span>, <span class="number">5</span>],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>Signiture의 길이는 10으로 하고, p = 7로 잡아서 MinHash를 구하기 위한 해시 함수를 만들어 보자. Signiture의 길이만큼 해시 함수가 필요하다. a는 소수, b는 2의 배수로 정해서 해시 함수의 결과를 반환하는 함수를 보자. 소수를 쉽게 가져오기 위해 <a href="https://github.com/ruby/prime" target="_blank" rel="noopener">prime</a> 젬을 사용했다.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'prime'</span></span><br><span class="line"></span><br><span class="line">@coefficient = Prime.take(<span class="number">10</span>) <span class="comment"># [2, 3, 5, 7, 11, 13, 17, 19, 23, 29]</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">min_hash</span><span class="params">(index, value)</span></span></span><br><span class="line">  (@coefficient[index] * value.to_i + <span class="number">2</span> * index) % <span class="number">7</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>2번째 사용자의 첫 MinHash 값은</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  min_hash(<span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">  min_hash(<span class="number">0</span>, <span class="number">4</span>),</span><br><span class="line">  min_hash(<span class="number">0</span>, <span class="number">5</span>),</span><br><span class="line">].min <span class="comment"># = 1</span></span><br></pre></td></tr></table></figure>
<p>이고, 그 다음 Minhash 값은</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  min_hash(<span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">  min_hash(<span class="number">1</span>, <span class="number">4</span>),</span><br><span class="line">  min_hash(<span class="number">1</span>, <span class="number">5</span>),</span><br><span class="line">].min <span class="comment"># = 0</span></span><br></pre></td></tr></table></figure>
<p>이다. 이런 식으로 구한 2번째 사용자의 Signiture는 <code>[1, 0, 1, 6, 0, 2, 1, 4, 3, 1]</code> 이다. 전체 사용자의 Signiture를 구하는 코드는 다음과 같다.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@signitures = @likes_data.map <span class="keyword">do</span> <span class="params">|likes|</span></span><br><span class="line">  [*(<span class="number">0</span>...<span class="number">10</span>)].map <span class="keyword">do</span> <span class="params">|i|</span></span><br><span class="line">    likes.map <span class="keyword">do</span> <span class="params">|like|</span></span><br><span class="line">      min_hash(i, like)</span><br><span class="line">    <span class="keyword">end</span>.min</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>각 사용자의 Signiture는 아래와 같다.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  [<span class="number">4</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>],</span><br><span class="line">  [<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">1</span>], <span class="comment"># 2번째 사용자 (나)</span></span><br><span class="line">  [<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">1</span>],</span><br><span class="line">  [<span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">2</span>],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>잠깐 멈춰서 계산을 해보자. 2번째 사용자의 Signiture는 1번째 사용자와 10%, 3번째 사용자와 70%, 4번째 사용자와는 20% 일치한다. 그러므로 우리는 3번째 사용자가 좋아한 아이템 중, 2번째 사용자가 좋아하지 않은 것을 추천해 주면 되겠다. (<code>likes_data[2] - likes_data[1]</code>)</p>
<p>발표 자료에도 나와 있듯, 모든 사용자를 하나하나 비교하는 것은 비효율적이다. Signiture의 위치와 값으로 Secondary Index를 만들어, Secondary Index lookup 만으로 유사도를 계산해 보자. 우선 Signiture를 Secondary Index key로 변환하는 함수를 만들자.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">signiture_to_key</span><span class="params">(signiture)</span></span></span><br><span class="line">  signiture.map.with_index <span class="keyword">do</span> <span class="params">|sig, index|</span></span><br><span class="line">    <span class="string">"<span class="subst">#&#123;sig&#125;</span>-<span class="subst">#&#123;index&#125;</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>2번째 사용자의 Signiture를 이 함수에 넣고 돌리면</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">"1-0"</span>, <span class="string">"0-1"</span>, <span class="string">"1-2"</span>, <span class="string">"6-3"</span>, <span class="string">"0-4"</span>, <span class="string">"2-5"</span>, <span class="string">"1-6"</span>, <span class="string">"4-7"</span>, <span class="string">"3-8"</span>, <span class="string">"1-9"</span>]</span><br></pre></td></tr></table></figure>
<p>이렇게 뒤에 Index가 붙게 되는 것을 확인할 수 있다. 다음으로 이렇게 만든 키에 사용자 목록을 값으로 가지는 Secondary Index를 만들어 보자. </p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@secondary_index = &#123;&#125;</span><br><span class="line"></span><br><span class="line">@signitures.map.with_index <span class="keyword">do</span> <span class="params">|signiture, user|</span></span><br><span class="line">  keys = signiture_to_key(signiture)</span><br><span class="line">  keys.each <span class="keyword">do</span> <span class="params">|key|</span></span><br><span class="line">    @secondary_index[key] <span class="params">||</span>= []</span><br><span class="line">    @secondary_index[key] &lt;&lt; user</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>만들어진 Secondary Index 목록은 아래와 같다. 2번째 사용자의 Secondary Index key를 찾기 쉽도록 순서를 약간 바꿨다.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"1-0"</span>=&gt;[<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">  <span class="string">"0-1"</span>=&gt;[<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">  <span class="string">"1-2"</span>=&gt;[<span class="number">1</span>],</span><br><span class="line">  <span class="string">"4-0"</span>=&gt;[<span class="number">0</span>],</span><br><span class="line">  <span class="string">"6-3"</span>=&gt;[<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">  <span class="string">"0-4"</span>=&gt;[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">  <span class="string">"2-5"</span>=&gt;[<span class="number">1</span>],</span><br><span class="line">  <span class="string">"1-6"</span>=&gt;[<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">  <span class="string">"4-7"</span>=&gt;[<span class="number">1</span>],</span><br><span class="line">  <span class="string">"3-8"</span>=&gt;[<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">  <span class="string">"1-9"</span>=&gt;[<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">  <span class="string">"1-1"</span>=&gt;[<span class="number">0</span>, <span class="number">3</span>],</span><br><span class="line">  <span class="string">"0-2"</span>=&gt;[<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">  <span class="string">"2-4"</span>=&gt;[<span class="number">0</span>],</span><br><span class="line">  <span class="string">"0-5"</span>=&gt;[<span class="number">0</span>],</span><br><span class="line">  <span class="string">"0-6"</span>=&gt;[<span class="number">0</span>],</span><br><span class="line">  <span class="string">"1-7"</span>=&gt;[<span class="number">0</span>],</span><br><span class="line">  <span class="string">"1-8"</span>=&gt;[<span class="number">0</span>],</span><br><span class="line">  <span class="string">"0-9"</span>=&gt;[<span class="number">0</span>],</span><br><span class="line">  <span class="string">"1-5"</span>=&gt;[<span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">  <span class="string">"3-7"</span>=&gt;[<span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">  <span class="string">"3-0"</span>=&gt;[<span class="number">3</span>],</span><br><span class="line">  <span class="string">"4-6"</span>=&gt;[<span class="number">3</span>],</span><br><span class="line">  <span class="string">"5-8"</span>=&gt;[<span class="number">3</span>],</span><br><span class="line">  <span class="string">"2-9"</span>=&gt;[<span class="number">3</span>],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이제 우리가 임의의 사용자를 집어넣으면, 그 사용자와 비슷한 다른 사용자를 반환해 주면 된다. 이미 Secondary Index까지 만들어 두었으니, 할 일은 그저 임의의 사용자의 Signiture를 Secondary Index key로 변환하고, Secondary Index에서 값을 읽어 와서 모두 합치는 것뿐이다. 두 번째 사용자와 비슷한 사용자를 찾는 코드는 다음과 같다.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">signiture_to_key(@signitures[<span class="number">1</span>]).reduce([]) <span class="keyword">do</span> <span class="params">|users, key|</span></span><br><span class="line">  users &lt;&lt; @secondary_index[key]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment"># [[1, 2], [1, 2], [1], [0, 1, 2, 3], [1, 2, 3], [1], [1, 2], [1], [1, 2], [1, 2]]</span></span><br></pre></td></tr></table></figure>
<p>각 Signiture 별로 일치하는 사용자 목록을 가져온 것이다. 이제 사용자 아이디의 등장 횟수를 세어 보자.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">signiture_to_key(@signitures[<span class="number">1</span>]).reduce([]) <span class="keyword">do</span> <span class="params">|users, key|</span></span><br><span class="line">  users &lt;&lt; @secondary_index[key]</span><br><span class="line"><span class="keyword">end</span>.flatten.</span><br><span class="line">  <span class="comment"># [1, 2, 1, 2, 1, 0, 1, 2, 3, 1, 2, 3, 1, 1, 2, 1, 1, 2, 1, 2]</span></span><br><span class="line">  group_by(&amp;<span class="symbol">:itself</span>).</span><br><span class="line">  <span class="comment"># &#123;</span></span><br><span class="line">  <span class="comment">#   1=&gt;[1, 1, 1, 1, 1, 1, 1, 1, 1, 1],</span></span><br><span class="line">  <span class="comment">#   2=&gt;[2, 2, 2, 2, 2, 2, 2],</span></span><br><span class="line">  <span class="comment">#   0=&gt;[0],</span></span><br><span class="line">  <span class="comment">#   3=&gt;[3, 3]</span></span><br><span class="line">  <span class="comment"># &#125;</span></span><br><span class="line">  transform_values(&amp;<span class="symbol">:count</span>)</span><br><span class="line">  <span class="comment"># &#123;1=&gt;10, 2=&gt;7, 0=&gt;1, 3=&gt;2&#125;</span></span><br></pre></td></tr></table></figure>
<p>실행하면 아래와 같이 출력된다.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="number">1</span>=&gt;<span class="number">10</span>, <span class="number">2</span>=&gt;<span class="number">7</span>, <span class="number">0</span>=&gt;<span class="number">1</span>, <span class="number">3</span>=&gt;<span class="number">2</span>&#125;</span><br></pre></td></tr></table></figure>
<p>자기 자신과는 100% 일치, 3번 사용자와 70% 일치, 1번 사용자와 10% 일치, 4번 사용자와 20% 일치한다. 앞서 우리가 계산한 결과와 같다. 조금 더 욕심을 부려 보자면, 가장 비슷한 한 명을 찾아볼 수 있겠다.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">signiture_to_key(@signitures[<span class="number">1</span>]).reduce([]) <span class="keyword">do</span> <span class="params">|users, key|</span></span><br><span class="line">  users &lt;&lt; @secondary_index[key]</span><br><span class="line"><span class="keyword">end</span>.flatten.</span><br><span class="line">  group_by(&amp;<span class="symbol">:itself</span>).</span><br><span class="line">  transform_values(&amp;<span class="symbol">:count</span>).</span><br><span class="line">  sort_by &#123; <span class="params">|key, value|</span> -value &#125;.</span><br><span class="line">  <span class="comment"># [[1, 10], [2, 7], [3, 2], [0, 1]]</span></span><br><span class="line">  slice(<span class="number">1</span>)</span><br><span class="line">  <span class="comment"># [2, 7]</span></span><br></pre></td></tr></table></figure>
<p>2번 유저가 70% 일치한다고 나올 것이다. 마지막으로 비슷한 사용자를 기반으로 아이템을 추천해 주는 함수까지 만들어 보자.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recommended_for</span><span class="params">(user)</span></span></span><br><span class="line">  neighbor = signiture_to_key(@signitures[user]).reduce([]) <span class="keyword">do</span> <span class="params">|users, key|</span></span><br><span class="line">    users &lt;&lt; @secondary_index[key]</span><br><span class="line">  <span class="keyword">end</span>.flatten.</span><br><span class="line">    group_by(&amp;<span class="symbol">:itself</span>).</span><br><span class="line">    transform_values(&amp;<span class="symbol">:count</span>).</span><br><span class="line">    sort_by &#123; <span class="params">|key, value|</span> -value &#125;.</span><br><span class="line">    slice(<span class="number">1</span>).</span><br><span class="line">    first</span><br><span class="line"></span><br><span class="line">  @likes_data[neighbor] - @likes_data[user]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># puts recommended_for(1)</span></span><br></pre></td></tr></table></figure>
<p>전체 코드는 다음과 같다.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'prime'</span></span><br><span class="line"></span><br><span class="line">@coefficient = Prime.take(<span class="number">10</span>) <span class="comment"># [2, 3, 5, 7, 11, 13, 17, 19, 23, 29]</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">min_hash</span><span class="params">(index, value)</span></span></span><br><span class="line">  (@coefficient[index] * value.to_i + <span class="number">2</span> * index) % <span class="number">7</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">signiture_to_key</span><span class="params">(signiture)</span></span></span><br><span class="line">  signiture.map.with_index <span class="keyword">do</span> <span class="params">|sig, index|</span></span><br><span class="line">    <span class="string">"<span class="subst">#&#123;sig&#125;</span>-<span class="subst">#&#123;index&#125;</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recommended_for</span><span class="params">(user)</span></span></span><br><span class="line">  nearest_neighbor = signiture_to_key(@signitures[user]).reduce([]) <span class="keyword">do</span> <span class="params">|users, key|</span></span><br><span class="line">    users &lt;&lt; @secondary_index[key]</span><br><span class="line">  <span class="keyword">end</span>.flatten</span><br><span class="line">    .group_by(&amp;<span class="symbol">:itself</span>)</span><br><span class="line">    .transform_values(&amp;<span class="symbol">:count</span>)</span><br><span class="line">    .sort_by &#123; <span class="params">|key, value|</span> -value &#125;</span><br><span class="line">    .slice(<span class="number">1</span>)</span><br><span class="line">    .first</span><br><span class="line"></span><br><span class="line">  @likes_data[nearest_neighbor] - @likes_data[user]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">@likes_data = [</span><br><span class="line">  [<span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">  [<span class="number">1</span>, <span class="number">4</span>, <span class="number">5</span>], <span class="comment"># 2번째 사용자 (나)</span></span><br><span class="line">  [<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">5</span>],</span><br><span class="line">  [<span class="number">2</span>, <span class="number">5</span>],</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">@signitures = @likes_data.map <span class="keyword">do</span> <span class="params">|likes|</span></span><br><span class="line">  [*(<span class="number">0</span>...<span class="number">10</span>)].map <span class="keyword">do</span> <span class="params">|i|</span></span><br><span class="line">    likes.map <span class="keyword">do</span> <span class="params">|like|</span></span><br><span class="line">      min_hash(i, like)</span><br><span class="line">    <span class="keyword">end</span>.min</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">@secondary_index = &#123;&#125;</span><br><span class="line"></span><br><span class="line">@signitures.map.with_index <span class="keyword">do</span> <span class="params">|signiture, user|</span></span><br><span class="line">  keys = signiture_to_key(signiture)</span><br><span class="line">  keys.each <span class="keyword">do</span> <span class="params">|key|</span></span><br><span class="line">    @secondary_index[key] <span class="params">||</span>= []</span><br><span class="line">    @secondary_index[key] &lt;&lt; user</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">puts recommended_for(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p><code>recommended_for</code> 함수의 인자를 변경해 가며 각 사용자가 어떤 아이템을 추천받는지 확인해 볼 수 있다. 여기서 더 나아가면 비슷한 사용자 한 명이 아니라 여러 명을 가져와서 선호 데이터를 더 늘릴 수도 있고, <code>@likes_data</code>, <code>@signitures</code>, <code>@secondary_index</code>를 Redis를 통해 관리할 수도 있다. 여기까지 구현한 코드는 <a href="https://github.com/mu29/dessert" target="_blank" rel="noopener">이곳</a>에서 확인할 수 있다.</p>

                    
                        

                    
                    
                        <p>
                            <a href="/2019/04/07/50-lines-of-recommendation-engine/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
        <li class="pagination-number">page 1 of 1</li>
    </ul>
</div>

</section>


                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2020 Injung Chung. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <h4 id="about-card-name">Injung Chung</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Software Engineer @SNOW</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Seoul, Korea
            </div>
        
    </div>
</div>

        
        <div id="cover" style="background-color: #4768AD"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-qdsxe3xwxumzudv25r0gv6xw32omhoauwpjmw5hxpuufed8g00jpgurgzgtc.min.js"></script>
<!--SCRIPTS END-->



    </body>
</html>
